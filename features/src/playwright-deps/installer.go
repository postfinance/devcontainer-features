package main

import (
	"builder/installer"
	"flag"
	"fmt"
	"os"
)

func main() {
	if err := runMain(); err != nil {
		fmt.Printf("Error: %v\n", err)
		os.Exit(1)
	}
}

func runMain() error {
	// Handle the flags
	installChromiumDeps := flag.Bool("installChromiumDeps", true, "A flag to indicate if the Chromium dependencies should be installed.")
	installFirefoxDeps := flag.Bool("installFirefoxDeps", true, "A flag to indicate if the Firefox dependencies should be installed.")
	installWebkitDeps := flag.Bool("installWebkitDeps", true, "A flag to indicate if the Webkit dependencies should be installed.")
	flag.Parse()

	fmt.Println("Installing Playwright Dependencies")

	// Get the os info
	osInfo, err := installer.Tools.System.GetOsInfo()
	if err != nil {
		return fmt.Errorf("failed to get OS info: %w", err)
	}

	fmt.Printf("Installing for %s version %d:\n", osInfo.Vendor, osInfo.MajorVersion())
	versionKey := fmt.Sprintf("%s%d", osInfo.Vendor, osInfo.MajorVersion())

	// Collect the dependencies to install
	neededDependencies := []string{}
	neededDependencies = append(neededDependencies, dependencies[versionKey]["tools"]...)
	if *installChromiumDeps {
		neededDependencies = append(neededDependencies, dependencies[versionKey]["chromium"]...)
	}
	if *installFirefoxDeps {
		neededDependencies = append(neededDependencies, dependencies[versionKey]["firefox"]...)
	}
	if *installWebkitDeps {
		neededDependencies = append(neededDependencies, dependencies[versionKey]["webkit"]...)
	}
	uniqueDependencies := uniq(neededDependencies)

	return installer.Tools.Apt.InstallDependencies(uniqueDependencies...)
}

func uniq[T comparable, Slice ~[]T](collection Slice) Slice {
	result := make(Slice, 0, len(collection))
	seen := make(map[T]struct{}, len(collection))
	for i := range collection {
		if _, ok := seen[collection[i]]; ok {
			continue
		}
		seen[collection[i]] = struct{}{}
		result = append(result, collection[i])
	}
	return result
}

// Dependencies taken from: https://github.com/microsoft/playwright/blob/main/packages/playwright-core/src/server/registry/nativeDeps.ts
var dependencies = map[string]map[string][]string{
	"ubuntu20": {
		"tools": []string{
			"xvfb",
			"fonts-noto-color-emoji",
			"ttf-unifont",
			"libfontconfig",
			"libfreetype6",
			"xfonts-cyrillic",
			"xfonts-scalable",
			"fonts-liberation",
			"fonts-ipafont-gothic",
			"fonts-wqy-zenhei",
			"fonts-tlwg-loma-otf",
			"ttf-ubuntu-font-family",
		},
		"chromium": []string{
			"fonts-liberation",
			"libasound2",
			"libatk-bridge2.0-0",
			"libatk1.0-0",
			"libatspi2.0-0",
			"libcairo2",
			"libcups2",
			"libdbus-1-3",
			"libdrm2",
			"libegl1",
			"libgbm1",
			"libglib2.0-0",
			"libgtk-3-0",
			"libnspr4",
			"libnss3",
			"libpango-1.0-0",
			"libx11-6",
			"libx11-xcb1",
			"libxcb1",
			"libxcomposite1",
			"libxdamage1",
			"libxext6",
			"libxfixes3",
			"libxrandr2",
			"libxshmfence1",
		},
		"firefox": []string{
			"ffmpeg",
			"libatk1.0-0",
			"libcairo-gobject2",
			"libcairo2",
			"libdbus-1-3",
			"libdbus-glib-1-2",
			"libfontconfig1",
			"libfreetype6",
			"libgdk-pixbuf2.0-0",
			"libglib2.0-0",
			"libgtk-3-0",
			"libpango-1.0-0",
			"libpangocairo-1.0-0",
			"libpangoft2-1.0-0",
			"libx11-6",
			"libx11-xcb1",
			"libxcb-shm0",
			"libxcb1",
			"libxcomposite1",
			"libxcursor1",
			"libxdamage1",
			"libxext6",
			"libxfixes3",
			"libxi6",
			"libxrender1",
			"libxt6",
			"libxtst6",
		},
		"webkit": []string{
			"libenchant-2-2",
			"libflite1",
			"libx264-155",
			"libatk-bridge2.0-0",
			"libatk1.0-0",
			"libcairo2",
			"libegl1",
			"libenchant1c2a",
			"libepoxy0",
			"libevdev2",
			"libfontconfig1",
			"libfreetype6",
			"libgdk-pixbuf2.0-0",
			"libgl1",
			"libgles2",
			"libglib2.0-0",
			"libgtk-3-0",
			"libgudev-1.0-0",
			"libharfbuzz-icu0",
			"libharfbuzz0b",
			"libhyphen0",
			"libicu66",
			"libjpeg-turbo8",
			"libnghttp2-14",
			"libnotify4",
			"libopengl0",
			"libopenjp2-7",
			"libopus0",
			"libpango-1.0-0",
			"libpng16-16",
			"libsecret-1-0",
			"libvpx6",
			"libwayland-client0",
			"libwayland-egl1",
			"libwayland-server0",
			"libwebp6",
			"libwebpdemux2",
			"libwoff1",
			"libx11-6",
			"libxcomposite1",
			"libxdamage1",
			"libxkbcommon0",
			"libxml2",
			"libxslt1.1",
			"libatomic1",
			"libevent-2.1-7",
		},
	},
	"ubuntu22": {
		"tools": []string{
			"xvfb",
			"fonts-noto-color-emoji",
			"fonts-unifont",
			"libfontconfig1",
			"libfreetype6",
			"xfonts-cyrillic",
			"xfonts-scalable",
			"fonts-liberation",
			"fonts-ipafont-gothic",
			"fonts-wqy-zenhei",
			"fonts-tlwg-loma-otf",
			"fonts-freefont-ttf",
		},
		"chromium": []string{
			"libasound2",
			"libatk-bridge2.0-0",
			"libatk1.0-0",
			"libatspi2.0-0",
			"libcairo2",
			"libcups2",
			"libdbus-1-3",
			"libdrm2",
			"libgbm1",
			"libglib2.0-0",
			"libnspr4",
			"libnss3",
			"libpango-1.0-0",
			"libwayland-client0",
			"libx11-6",
			"libxcb1",
			"libxcomposite1",
			"libxdamage1",
			"libxext6",
			"libxfixes3",
			"libxkbcommon0",
			"libxrandr2",
		},
		"firefox": []string{
			"ffmpeg",
			"libasound2",
			"libatk1.0-0",
			"libcairo-gobject2",
			"libcairo2",
			"libdbus-1-3",
			"libdbus-glib-1-2",
			"libfontconfig1",
			"libfreetype6",
			"libgdk-pixbuf-2.0-0",
			"libglib2.0-0",
			"libgtk-3-0",
			"libpango-1.0-0",
			"libpangocairo-1.0-0",
			"libx11-6",
			"libx11-xcb1",
			"libxcb-shm0",
			"libxcb1",
			"libxcomposite1",
			"libxcursor1",
			"libxdamage1",
			"libxext6",
			"libxfixes3",
			"libxi6",
			"libxrandr2",
			"libxrender1",
			"libxtst6",
		},
		"webkit": []string{
			"libsoup-3.0-0",
			"libenchant-2-2",
			"gstreamer1.0-libav",
			"gstreamer1.0-plugins-bad",
			"gstreamer1.0-plugins-base",
			"gstreamer1.0-plugins-good",
			"libicu70",
			"libatk-bridge2.0-0",
			"libatk1.0-0",
			"libcairo2",
			"libdbus-1-3",
			"libdrm2",
			"libegl1",
			"libepoxy0",
			"libevdev2",
			"libffi7",
			"libfontconfig1",
			"libfreetype6",
			"libgbm1",
			"libgdk-pixbuf-2.0-0",
			"libgles2",
			"libglib2.0-0",
			"libglx0",
			"libgstreamer-gl1.0-0",
			"libgstreamer-plugins-base1.0-0",
			"libgstreamer1.0-0",
			"libgtk-4-1",
			"libgudev-1.0-0",
			"libharfbuzz-icu0",
			"libharfbuzz0b",
			"libhyphen0",
			"libjpeg-turbo8",
			"liblcms2-2",
			"libmanette-0.2-0",
			"libnotify4",
			"libopengl0",
			"libopenjp2-7",
			"libopus0",
			"libpango-1.0-0",
			"libpng16-16",
			"libproxy1v5",
			"libsecret-1-0",
			"libwayland-client0",
			"libwayland-egl1",
			"libwayland-server0",
			"libwebpdemux2",
			"libwoff1",
			"libx11-6",
			"libxcomposite1",
			"libxdamage1",
			"libxkbcommon0",
			"libxml2",
			"libxslt1.1",
			"libx264-163",
			"libatomic1",
			"libevent-2.1-7",
			"libavif13",
		},
	},
	"ubuntu24": {
		"tools": []string{
			"xvfb",
			"fonts-noto-color-emoji",
			"fonts-unifont",
			"libfontconfig1",
			"libfreetype6",
			"xfonts-cyrillic",
			"xfonts-scalable",
			"fonts-liberation",
			"fonts-ipafont-gothic",
			"fonts-wqy-zenhei",
			"fonts-tlwg-loma-otf",
			"fonts-freefont-ttf",
		},
		"chromium": []string{
			"libasound2t64",
			"libatk-bridge2.0-0t64",
			"libatk1.0-0t64",
			"libatspi2.0-0t64",
			"libcairo2",
			"libcups2t64",
			"libdbus-1-3",
			"libdrm2",
			"libgbm1",
			"libglib2.0-0t64",
			"libnspr4",
			"libnss3",
			"libpango-1.0-0",
			"libx11-6",
			"libxcb1",
			"libxcomposite1",
			"libxdamage1",
			"libxext6",
			"libxfixes3",
			"libxkbcommon0",
			"libxrandr2",
		},
		"firefox": []string{
			"libasound2t64",
			"libatk1.0-0t64",
			"libcairo-gobject2",
			"libcairo2",
			"libdbus-1-3",
			"libfontconfig1",
			"libfreetype6",
			"libgdk-pixbuf-2.0-0",
			"libglib2.0-0t64",
			"libgtk-3-0t64",
			"libpango-1.0-0",
			"libpangocairo-1.0-0",
			"libx11-6",
			"libx11-xcb1",
			"libxcb-shm0",
			"libxcb1",
			"libxcomposite1",
			"libxcursor1",
			"libxdamage1",
			"libxext6",
			"libxfixes3",
			"libxi6",
			"libxrandr2",
			"libxrender1",
		},
		"webkit": []string{
			"gstreamer1.0-libav",
			"gstreamer1.0-plugins-bad",
			"gstreamer1.0-plugins-base",
			"gstreamer1.0-plugins-good",
			"libicu74",
			"libatomic1",
			"libatk-bridge2.0-0t64",
			"libatk1.0-0t64",
			"libcairo-gobject2",
			"libcairo2",
			"libdbus-1-3",
			"libdrm2",
			"libenchant-2-2",
			"libepoxy0",
			"libevent-2.1-7t64",
			"libflite1",
			"libfontconfig1",
			"libfreetype6",
			"libgbm1",
			"libgdk-pixbuf-2.0-0",
			"libgles2",
			"libglib2.0-0t64",
			"libgstreamer-gl1.0-0",
			"libgstreamer-plugins-bad1.0-0",
			"libgstreamer-plugins-base1.0-0",
			"libgstreamer1.0-0",
			"libgtk-4-1",
			"libharfbuzz-icu0",
			"libharfbuzz0b",
			"libhyphen0",
			"libicu74",
			"libjpeg-turbo8",
			"liblcms2-2",
			"libmanette-0.2-0",
			"libopus0",
			"libpango-1.0-0",
			"libpangocairo-1.0-0",
			"libpng16-16t64",
			"libsecret-1-0",
			"libvpx9",
			"libwayland-client0",
			"libwayland-egl1",
			"libwayland-server0",
			"libwebp7",
			"libwebpdemux2",
			"libwoff1",
			"libx11-6",
			"libxkbcommon0",
			"libxml2",
			"libxslt1.1",
			"libx264-164",
			"libavif16",
		},
	},

	"debian11": {
		"tools": []string{
			"xvfb",
			"fonts-noto-color-emoji",
			"fonts-unifont",
			"libfontconfig1",
			"libfreetype6",
			"xfonts-cyrillic",
			"xfonts-scalable",
			"fonts-liberation",
			"fonts-ipafont-gothic",
			"fonts-wqy-zenhei",
			"fonts-tlwg-loma-otf",
			"fonts-freefont-ttf",
		},
		"chromium": []string{
			"libasound2",
			"libatk-bridge2.0-0",
			"libatk1.0-0",
			"libatspi2.0-0",
			"libcairo2",
			"libcups2",
			"libdbus-1-3",
			"libdrm2",
			"libgbm1",
			"libglib2.0-0",
			"libnspr4",
			"libnss3",
			"libpango-1.0-0",
			"libwayland-client0",
			"libx11-6",
			"libxcb1",
			"libxcomposite1",
			"libxdamage1",
			"libxext6",
			"libxfixes3",
			"libxkbcommon0",
			"libxrandr2",
		},
		"firefox": []string{
			"libasound2",
			"libatk1.0-0",
			"libcairo-gobject2",
			"libcairo2",
			"libdbus-1-3",
			"libdbus-glib-1-2",
			"libfontconfig1",
			"libfreetype6",
			"libgdk-pixbuf-2.0-0",
			"libglib2.0-0",
			"libgtk-3-0",
			"libharfbuzz0b",
			"libpango-1.0-0",
			"libpangocairo-1.0-0",
			"libx11-6",
			"libx11-xcb1",
			"libxcb-shm0",
			"libxcb1",
			"libxcomposite1",
			"libxcursor1",
			"libxdamage1",
			"libxext6",
			"libxfixes3",
			"libxi6",
			"libxrandr2",
			"libxrender1",
			"libxtst6",
		},
		"webkit": []string{
			"gstreamer1.0-libav",
			"gstreamer1.0-plugins-bad",
			"gstreamer1.0-plugins-base",
			"gstreamer1.0-plugins-good",
			"libatk-bridge2.0-0",
			"libatk1.0-0",
			"libcairo2",
			"libdbus-1-3",
			"libdrm2",
			"libegl1",
			"libenchant-2-2",
			"libepoxy0",
			"libevdev2",
			"libfontconfig1",
			"libfreetype6",
			"libgbm1",
			"libgdk-pixbuf-2.0-0",
			"libgles2",
			"libglib2.0-0",
			"libglx0",
			"libgstreamer-gl1.0-0",
			"libgstreamer-plugins-base1.0-0",
			"libgstreamer1.0-0",
			"libgtk-3-0",
			"libgudev-1.0-0",
			"libharfbuzz-icu0",
			"libharfbuzz0b",
			"libhyphen0",
			"libicu67",
			"libjpeg62-turbo",
			"liblcms2-2",
			"libmanette-0.2-0",
			"libnghttp2-14",
			"libnotify4",
			"libopengl0",
			"libopenjp2-7",
			"libopus0",
			"libpango-1.0-0",
			"libpng16-16",
			"libproxy1v5",
			"libsecret-1-0",
			"libwayland-client0",
			"libwayland-egl1",
			"libwayland-server0",
			"libwebp6",
			"libwebpdemux2",
			"libwoff1",
			"libx11-6",
			"libxcomposite1",
			"libxdamage1",
			"libxkbcommon0",
			"libxml2",
			"libxslt1.1",
			"libatomic1",
			"libevent-2.1-7",
		},
	},
	"debian12": {
		"tools": []string{
			"xvfb",
			"fonts-noto-color-emoji",
			"fonts-unifont",
			"libfontconfig1",
			"libfreetype6",
			"xfonts-scalable",
			"fonts-liberation",
			"fonts-ipafont-gothic",
			"fonts-wqy-zenhei",
			"fonts-tlwg-loma-otf",
			"fonts-freefont-ttf",
		},
		"chromium": []string{
			"libasound2",
			"libatk-bridge2.0-0",
			"libatk1.0-0",
			"libatspi2.0-0",
			"libcairo2",
			"libcups2",
			"libdbus-1-3",
			"libdrm2",
			"libgbm1",
			"libglib2.0-0",
			"libnspr4",
			"libnss3",
			"libpango-1.0-0",
			"libx11-6",
			"libxcb1",
			"libxcomposite1",
			"libxdamage1",
			"libxext6",
			"libxfixes3",
			"libxkbcommon0",
			"libxrandr2",
		},
		"firefox": []string{
			"libasound2",
			"libatk1.0-0",
			"libcairo-gobject2",
			"libcairo2",
			"libdbus-1-3",
			"libdbus-glib-1-2",
			"libfontconfig1",
			"libfreetype6",
			"libgdk-pixbuf-2.0-0",
			"libglib2.0-0",
			"libgtk-3-0",
			"libharfbuzz0b",
			"libpango-1.0-0",
			"libpangocairo-1.0-0",
			"libx11-6",
			"libx11-xcb1",
			"libxcb-shm0",
			"libxcb1",
			"libxcomposite1",
			"libxcursor1",
			"libxdamage1",
			"libxext6",
			"libxfixes3",
			"libxi6",
			"libxrandr2",
			"libxrender1",
			"libxtst6",
		},
		"webkit": []string{
			"libsoup-3.0-0",
			"gstreamer1.0-libav",
			"gstreamer1.0-plugins-bad",
			"gstreamer1.0-plugins-base",
			"gstreamer1.0-plugins-good",
			"libatk-bridge2.0-0",
			"libatk1.0-0",
			"libcairo2",
			"libdbus-1-3",
			"libdrm2",
			"libegl1",
			"libenchant-2-2",
			"libepoxy0",
			"libevdev2",
			"libfontconfig1",
			"libfreetype6",
			"libgbm1",
			"libgdk-pixbuf-2.0-0",
			"libgles2",
			"libglib2.0-0",
			"libglx0",
			"libgstreamer-gl1.0-0",
			"libgstreamer-plugins-base1.0-0",
			"libgstreamer1.0-0",
			"libgtk-4-1",
			"libgudev-1.0-0",
			"libharfbuzz-icu0",
			"libharfbuzz0b",
			"libhyphen0",
			"libicu72",
			"libjpeg62-turbo",
			"liblcms2-2",
			"libmanette-0.2-0",
			"libnotify4",
			"libopengl0",
			"libopenjp2-7",
			"libopus0",
			"libpango-1.0-0",
			"libpng16-16",
			"libproxy1v5",
			"libsecret-1-0",
			"libwayland-client0",
			"libwayland-egl1",
			"libwayland-server0",
			"libwebp7",
			"libwebpdemux2",
			"libwoff1",
			"libx11-6",
			"libxcomposite1",
			"libxdamage1",
			"libxkbcommon0",
			"libxml2",
			"libxslt1.1",
			"libatomic1",
			"libevent-2.1-7",
			"libavif15",
		},
	},
	"debian13": {
		"tools": []string{
			"xvfb",
			"fonts-noto-color-emoji",
			"fonts-unifont",
			"libfontconfig1",
			"libfreetype6",
			"xfonts-scalable",
			"fonts-liberation",
			"fonts-ipafont-gothic",
			"fonts-wqy-zenhei",
			"fonts-tlwg-loma-otf",
			"fonts-freefont-ttf",
		},
		"chromium": []string{
			"libasound2t64",
			"libatk-bridge2.0-0t64",
			"libatk1.0-0t64",
			"libatspi2.0-0t64",
			"libcairo2",
			"libcups2t64",
			"libdbus-1-3",
			"libdrm2",
			"libgbm1",
			"libglib2.0-0t64",
			"libnspr4",
			"libnss3",
			"libpango-1.0-0",
			"libx11-6",
			"libxcb1",
			"libxcomposite1",
			"libxdamage1",
			"libxext6",
			"libxfixes3",
			"libxkbcommon0",
			"libxrandr2",
		},
		"firefox": []string{
			"libasound2",
			"libatk1.0-0t64",
			"libcairo-gobject2",
			"libcairo2",
			"libdbus-1-3",
			"libdbus-glib-1-2",
			"libfontconfig1",
			"libfreetype6",
			"libgdk-pixbuf-2.0-0",
			"libglib2.0-0t64",
			"libgtk-3-0t64",
			"libharfbuzz0b",
			"libpango-1.0-0",
			"libpangocairo-1.0-0",
			"libx11-6",
			"libx11-xcb1",
			"libxcb-shm0",
			"libxcb1",
			"libxcomposite1",
			"libxcursor1",
			"libxdamage1",
			"libxext6",
			"libxfixes3",
			"libxi6",
			"libxrandr2",
			"libxrender1",
			"libxtst6",
		},
		"webkit": []string{
			"libsoup-3.0-0",
			"gstreamer1.0-libav",
			"gstreamer1.0-plugins-bad",
			"gstreamer1.0-plugins-base",
			"gstreamer1.0-plugins-good",
			"libatk-bridge2.0-0t64",
			"libatk1.0-0t64",
			"libcairo2",
			"libdbus-1-3",
			"libdrm2",
			"libegl1",
			"libenchant-2-2",
			"libepoxy0",
			"libevdev2",
			"libfontconfig1",
			"libfreetype6",
			"libgbm1",
			"libgdk-pixbuf-2.0-0",
			"libgles2",
			"libglib2.0-0t64",
			"libglx0",
			"libgstreamer-gl1.0-0",
			"libgstreamer-plugins-base1.0-0",
			"libgstreamer1.0-0",
			"libgtk-4-1",
			"libgudev-1.0-0",
			"libharfbuzz-icu0",
			"libharfbuzz0b",
			"libhyphen0",
			"libicu76",
			"libjpeg62-turbo",
			"liblcms2-2",
			"libmanette-0.2-0",
			"libnotify4",
			"libopengl0",
			"libopenjp2-7",
			"libopus0",
			"libpango-1.0-0",
			"libpng16-16t64",
			"libproxy1v5",
			"libsecret-1-0",
			"libwayland-client0",
			"libwayland-egl1",
			"libwayland-server0",
			"libwebp7",
			"libwebpdemux2",
			"libwoff1",
			"libx11-6",
			"libxcomposite1",
			"libxdamage1",
			"libxkbcommon0",
			"libxml2",
			"libxslt1.1",
			"libatomic1",
			"libevent-2.1-7t64",
			"libavif16",
		},
	},
}
